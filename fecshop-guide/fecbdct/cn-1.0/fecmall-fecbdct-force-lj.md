FecMall Fecbdct 强制囤货逻辑（附加）
=====================

> 1.某些商品的强势推力，进而可以以损失分销商的一部分利益做代价，
>
> 2.为了加快资金流的运转
>
> 在不可囤货产品类型，自愿囤货产品类型的基础上，加入强制分销商囤货的产品类型，

### Fecbdct 强制囤货产品

产品加入囤货类型：1.`自愿囤货`，2.`不可囤货`，3.`强制囤货`

可以在后台进行编辑产品该选项

`自愿囤货`: 对于该产品，分销商可以囤货，也可以不囤货，不影响分销，如果分销商囤货，那么用户下单优先扣除分销商囤货库存，
如果没有分销商囤货库存，那么扣除经销商库存


`不可囤货`: 对于该产品，不支持囤货，分销商不可以囤货

`强制囤货`：分销商必须囤货才能走通订单处理流程，当用户下单的时候，只进行库存检查，用户下单支付后，分销商审核的时候进行
分销商囤货库存扣除，如果库存不足，那么无法审核通过，需要分销商先去下单囤货，有囤货库存后，才能下单支付。


### 强制囤货产品下单

1.用户下单检查`囤货产品库存`

用户下单，在库存扣除部分，如果产品是`强制囤货产品`类型，那么只进行库存的检查，而不进行库存的扣除

1.1先检查分销商是否有`囤货库存`，如果有返回true

1.2如果分销商没有`囤货库存`，那么检查经销商是否有`库存`，如果有，返回`true`，否则返回`false`

订单产品表加入2个字段标识：

`product_stock_type`：1代表`强制囤货`产品，2代表`非强制囤货`产品（创建的时候，该值默认为`2`）

`is_deduct_distribute_stock`, 是否扣除`分销商囤货库存`：1代表`已经扣除`，2代表`未扣除`（创建的时候，该值默认为`1`）

如果是`非强制囤货`产品，该值使用`默认值`即可


如果是`强制囤货`产品，那么 `product_stock_type`为`1`，`is_deduct_distribute_stock`为`2`.进行保存处理


这个字段是为了分销商确认订单扣除库存的需要（因为强制囤货库存，在这个步骤没有扣除库存，只是检查，当然并不代表肯定有库存）


2.订单创建完成，用户支付，订单状态为`已支付订单`



3.分销商已支付订单审核

加入订单状态: `分销商审核通过distribute_audit_accept`, `分销商审核拒绝distribute_audit_refuse`，两个订单状态

在这个步骤，可以进行`分销商订单审核通过`，`分销商订单审核拒绝`，`订单取消操作`（分销商和经销商都没有库存，只能取消）

`分销商`在`分销商中心`进行订单审核操作


![](images/fecbdc-112.png)



3.1分销商审核通过操作逻辑：

条件：`订单状态-已支付订单状态`，`订单状态-分销商审核拒绝状态`

3.1.1如果订单产品，字段标识 `product_stock_type`都为`2`，则直接进行状态更改为`distribute_audit_accept`

3.1.2如果订单产品，字段标识 `product_stock_type`存在为`1`，则进行`强制囤货产品`的`库存扣除`，如果没有`囤货库存`，则报错返回，提示分销商
进行`囤货`处理

结果：如果存在`分销商囤货库存`，则进行库存的扣除，更改订单状态为`distribute_audit_accept`，订单产品`is_deduct_distribute_stock`改为1


3.2分销商审核拒绝操作：(相当于暂时挂起)

条件：`订单状态-已支付订单状态`

结果：更改订单状态为 `订单状态-分销商审核拒绝状态`

3.3分销商取消订单

条件：`订单状态-已支付订单状态`，`订单状态-分销商审核拒绝状态`

订单`取消`，`释放库存`，

结果：更改订单状态为 `订单状态-取消状态`

4.经销商审核


原来的操作条件：对支付成功的订单，进行`经销商审核`操作

更改后的：

进行订单类型判断

1.如果`非分销商订单`,则：`支付成功`的订单

2.如果是`分销商订单`，则：经销商审核通过状态`distribute_audit_accept`

满足这些条件的订单状态，才能进行下一步的 `经销商审核操作`



### 原来的逻辑更改：


1.取消订单

订单取消的时候，要检查订单产品字段

如果是分销商订单，则：

如果`product_stock_type`为2，则和原来的逻辑一样

如果`product_stock_type`为1，则检查
`is_deduct_distribute_stock`（1代表已经扣除，2代表未扣除）, 如果
为1，则进行库存的返还，如果为2，则不进行库存返还（因为没有扣除囤货库存）。


2.订单售后-订单退款退货

如果是分销商订单，则：

如果`product_stock_type`为2，则和原来的逻辑一样

如果`product_stock_type`为1，则检查
`is_deduct_distribute_stock`（1代表已经扣除，2代表未扣除）, 如果
为1，则进行库存的返还，如果为2，则不进行库存返还（因为没有扣除囤货库存）。



3.分销商提成计算脚本（不需要更改）

这个逻辑是这样，讨论后，不用更改，目前的逻辑为：

4.1有一个订单收货确认脚本，超过一定时间，将已发货的订单改为已收货

4.2这个月结脚本，统计上个月的已收货的订单，进行统计



### 脚本

1.超过x天内，分销商未进行审核的分销商订单，自动取消（所有订单），进行库存返还，用户退款

具体参看：[分销商未审核订单自动取消](fecmall-fecbdct-script-distribute-unaudit-order-cancel.md)

























